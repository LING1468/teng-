<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aipdfl.com - 2025 ç»ˆæçœŸAI PDFå¹³å°</title>
    <meta name="description" content="å…è´¹ä¸Šä¼ PDFï¼Œæ”¯æŒçœŸAIæ€»ç»“ã€å¤šè½®èŠå¤©ã€è¯­éŸ³æé—®ã€å¤šæ–‡ä»¶ç®¡ç†ã€æ€ç»´å¯¼å›¾å¯¼å‡ºã€åˆ†äº«èŠå¤©è®°å½•é“¾æ¥ã€‚">
    
    <!-- PDF.js ç”¨äºé¢„è§ˆç¬¬ä¸€é¡µ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
    
    <!-- markmap ç”¨äºæ€ç»´å¯¼å›¾ï¼ˆäº¤äº’SVGï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15"></script>

    <style>
        :root {
            --primary: #00e0ff;
            --primary-dark: #0066ff;
            --gradient: linear-gradient(135deg, #0a0020, #001133);
            --glow: 0 0 25px rgba(0,224,255,0.5);
            --card-bg: rgba(20,20,40,0.65);
            --text: #ffffff;
            --text-light: rgba(255,255,255,0.8);
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 60px 20px 40px; }
        header h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, #00e0ff, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .main-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 40px;
            box-shadow: var(--glow);
            border: 1px solid rgba(0,224,255,0.3);
        }
        .upload-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 30px;
            align-items: center;
        }
        input[type="file"] { display: none; }
        .btn {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            box-shadow: var(--glow);
            transition: 0.3s;
        }
        .btn:hover { transform: translateY(-3px); }
        .btn-voice {
            background: #ff3366;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100% { box-shadow: var(--glow); } 50% { box-shadow: 0 0 35px rgba(255,50,100,0.8); } }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; }
        
        #file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0;
        }
        .file-item {
            background: rgba(0,224,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #preview {
            margin: 30px 0;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--glow);
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        
        #chat {
            min-height: 400px;
            background: rgba(0,0,0,0.3);
            border-radius: 24px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }
        .msg {
            max-width: 80%;
            padding: 16px 24px;
            border-radius: 24px;
            line-height: 1.6;
        }
        .user { align-self: flex-end; background: linear-gradient(135deg, #0066ff, #00aaff); border-bottom-right-radius: 8px; }
        .ai { align-self: flex-start; background: rgba(0,224,255,0.25); border: 1px solid rgba(0,224,255,0.4); border-bottom-left-radius: 8px; }
        
        .input-bar {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        #input {
            flex: 1;
            padding: 18px 24px;
            border-radius: 50px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }
        
        #mindmap-container {
            margin: 40px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 24px;
            padding: 20px;
            display: none;
        }
        #markmap { width: 100%; height: 600px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>aipdfl.com</h1>
            <p style="font-size:1.4rem; opacity:0.9;">2025 ç»ˆæçœŸAI PDFå¹³å° Â· å®‰å…¨åç«¯é©±åŠ¨</p>
        </header>

        <div class="main-card">
            <div class="upload-bar">
                <label class="btn">é€‰æ‹©PDFï¼ˆæ”¯æŒå¤šé€‰ï¼‰<input type="file" id="pdf-input" accept=".pdf" multiple></label>
                <button class="btn" onclick="uploadPDFs()">ä¸Šä¼ å¹¶åˆ†æ</button>
                <button class="btn" onclick="generateMindmap()">ç”Ÿæˆæ€ç»´å¯¼å›¾</button>
                <button class="btn" onclick="shareChat()">åˆ†äº«èŠå¤©è®°å½•</button>
                <button class="btn btn-voice" onclick="startVoice()">ğŸ¤ è¯­éŸ³æé—®</button>
            </div>

            <div id="file-list"></div>

            <div id="preview"></div>

            <div id="mindmap-container">
                <div style="margin-bottom:15px;">
                    <button class="btn btn-small" onclick="exportMindmap('png')">å¯¼å‡ºPNG</button>
                    <button class="btn btn-small" onclick="exportMindmap('svg')">å¯¼å‡ºSVG</button>
                </div>
                <div id="markmap"></div>
            </div>

            <div id="chat"></div>

            <div class="input-bar">
                <input type="text" id="input" placeholder="å‘AIæé—®...ï¼ˆå›è½¦å‘é€ï¼‰">
                <button class="btn" onclick="send()">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';

        let files = [];                 // å¤šæ–‡ä»¶åˆ—è¡¨
        let currentFileIndex = 0;       // å½“å‰åˆ†æçš„æ–‡ä»¶
        let sessionId = null;           // å½“å‰ä¼šè¯ID
        let chatHistory = [];           // ç”¨äºåˆ†äº«

        function addMsg(sender, text) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'msg ' + (sender === 'ä½ ' ? 'user' : 'ai');
            div.innerHTML = text.replace(/\n/g, '<br>');
            chat.appendChild(div);
            chatHistory.push({sender, text});
            chat.scrollTop = chat.scrollHeight;
        }

        // å¤šæ–‡ä»¶ä¸Šä¼ ä¸åˆ—è¡¨
        async function uploadPDFs() {
            const input = document.getElementById('pdf-input');
            if (input.files.length === 0) return alert('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶');

            files = Array.from(input.files);
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            files.forEach((f, i) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    ${f.name}
                    <button class="btn-small" onclick="switchFile(${i})">åˆ†æ</button>
                    <button class="btn-small" onclick="removeFile(${i})">åˆ é™¤</button>
                `;
                list.appendChild(item);
            });

            // é»˜è®¤åˆ†æç¬¬ä¸€ä¸ª
            switchFile(0);
        }

        async function switchFile(index) {
            currentFileIndex = index;
            const file = files[index];
            addMsg('ç³»ç»Ÿ', `æ­£åœ¨åˆ†ææ–‡ä»¶ï¼š${file.name}`);

            const form = new FormData();
            form.append('file', file);

            try {
                const res = await fetch('/api/upload-pdf', { method: 'POST', body: form });
                const data = await res.json();

                if (data.sessionId && data.summary) {
                    sessionId = data.sessionId;
                    addMsg('ğŸ¤– AI', data.summary);

                    // æ˜¾ç¤ºç¬¬ä¸€é¡µé¢„è§ˆ
                    const preview = document.getElementById('preview');
                    preview.style.display = 'block';
                    preview.innerHTML = '<canvas style="width:100%;"></canvas>';
                    const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    const canvas = preview.querySelector('canvas');
                    const vp = page.getViewport({ scale: 1.5 });
                    canvas.height = vp.height; canvas.width = vp.width;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
                } else {
                    addMsg('é”™è¯¯', data.error || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (err) {
                addMsg('é”™è¯¯', 'ä¸Šä¼ è¯·æ±‚å¤±è´¥ï¼š' + err.message);
            }
        }

        function removeFile(index) {
            files.splice(index, 1);
            document.getElementById('file-list').innerHTML = '';
            uploadPDFs(); // åˆ·æ–°åˆ—è¡¨
        }

        // å‘é€é—®é¢˜
        async function send() {
            if (!sessionId) return addMsg('é”™è¯¯', 'è¯·å…ˆä¸Šä¼ PDFæ–‡ä»¶');

            const msg = document.getElementById('input').value.trim();
            if (!msg) return;

            addMsg('ä½ ', msg);
            document.getElementById('input').value = '';

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, sessionId })
                });
                const data = await res.json();
                addMsg('ğŸ¤– AI', data.reply || data.error || 'æ— å›å¤');
            } catch (err) {
                addMsg('é”™è¯¯', 'èŠå¤©å¤±è´¥ï¼š' + err.message);
            }
        }

        // å›è½¦å‘é€
        document.getElementById('input').addEventListener('keypress', e => {
            if (e.key === 'Enter') send();
        });

        // è¯­éŸ³æé—®
        function startVoice() {
            if (!('webkitSpeechRecognition' in window)) return alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.onresult = event => {
                const text = event.results[0][0].transcript;
                document.getElementById('input').value = text;
                send();
            };
            recognition.onerror = () => addMsg('é”™è¯¯', 'è¯­éŸ³è¯†åˆ«å¤±è´¥');
            recognition.start();
        }

        // ç”Ÿæˆæ€ç»´å¯¼å›¾
        async function generateMindmap() {
            if (!sessionId) return addMsg('é”™è¯¯', 'è¯·å…ˆä¸Šä¼ PDFå¹¶å®ŒæˆèŠå¤©');

            const res = await fetch('/api/mindmap', { method: 'POST' });
            const data = await res.json();

            if (data.markdown) {
                document.getElementById('mindmap-container').style.display = 'block';
                const { markmap } = window;
                markmap.Markmap.create('#markmap', {}, data.markdown);
            } else {
                addMsg('é”™è¯¯', data.error || 'ç”Ÿæˆæ€ç»´å¯¼å›¾å¤±è´¥');
            }
        }

        // å¯¼å‡ºæ€ç»´å¯¼å›¾
        function exportMindmap(type) {
            const svg = document.querySelector('#markmap svg');
            if (!svg) return alert('è¯·å…ˆç”Ÿæˆæ€ç»´å¯¼å›¾');

            if (type === 'svg') {
                const blob = new Blob([svg.outerHTML], {type: 'image/svg+xml'});
                download(blob, 'æ€ç»´å¯¼å›¾.svg');
            } else {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(blob => download(blob, 'æ€ç»´å¯¼å›¾.png'));
                };
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg.outerHTML)));
            }
        }

        function download(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // åˆ†äº«èŠå¤©è®°å½•é“¾æ¥
        function shareChat() {
            if (chatHistory.length === 0) return alert('æš‚æ— èŠå¤©è®°å½•å¯åˆ†äº«');

            const data = btoa(unescape(encodeURIComponent(JSON.stringify(chatHistory))));
            const link = location.origin + location.pathname + '?share=' + data;
            prompt('å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ†äº«èŠå¤©è®°å½•ï¼ˆä»»ä½•äººæ‰“å¼€å³å¯æŸ¥çœ‹ï¼‰ï¼š', link);
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤åˆ†äº«çš„èŠå¤©è®°å½•
        const params = new URLSearchParams(location.search);
        if (params.has('share')) {
            try {
                const history = JSON.parse(decodeURIComponent(escape(atob(params.get('share')))));
                history.forEach(m => addMsg(m.sender, m.text));
            } catch (e) {
                console.error('åˆ†äº«é“¾æ¥è§£æå¤±è´¥');
            }
        }
    </script>
</body>
</html>
