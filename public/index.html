<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aipdfl.com - 2025 ç»ˆæçœŸAI PDFå¹³å°</title>
    <meta name="description" content="å…è´¹ä¸Šä¼ PDFï¼Œæ”¯æŒçœŸAIæ€»ç»“ã€å¤šè½®èŠå¤©ã€è¯­éŸ³æé—®ã€å¤šæ–‡ä»¶ç®¡ç†ã€æ€ç»´å¯¼å›¾å¯¼å‡ºã€åˆ†äº«èŠå¤©è®°å½•é“¾æ¥ã€‚">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
    <!-- PDF.js ç”¨äºç¬¬ä¸€é¡µé¢„è§ˆ - ä½¿ç”¨ legacy ç‰ˆæœ¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- markmap ç”¨äºäº¤äº’å¼æ€ç»´å¯¼å›¾ -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"></script>

    <style>
        :root {
            --primary: #00e0ff;
            --primary-dark: #0066ff;
            --gradient: linear-gradient(135deg, #0a0020, #001133);
            --glow: 0 0 25px rgba(0,224,255,0.5);
            --card-bg: rgba(20,20,40,0.65);
            --text: #ffffff;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 60px 20px 40px; }
        header h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, #00e0ff, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .main-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 40px;
            box-shadow: var(--glow);
            border: 1px solid rgba(0,224,255,0.3);
        }
        .upload-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 30px;
            align-items: center;
        }
        input[type="file"] { display: none; }
        .btn {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            box-shadow: var(--glow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 35px rgba(0,224,255,0.7);
        }
        .btn:active {
            transform: translateY(-1px);
        }
        .btn-voice {
            background: linear-gradient(135deg, #ff3366, #ff5c8d);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%,100% { box-shadow: 0 0 25px rgba(255,50,100,0.5); }
            50% { box-shadow: 0 0 35px rgba(255,50,100,0.8); }
        }
        .btn-small {
            padding: 9px 17px;
            font-size: 0.87rem;
            border-radius: 24px;
        }
        .btn-small:hover {
            transform: translateY(-2px) scale(1.02);
        }

        #file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0;
        }
        .file-item {
            background: rgba(0,224,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #preview {
            margin: 30px 0;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--glow);
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }

        #chat {
            min-height: 400px;
            background: rgba(0,0,0,0.3);
            border-radius: 24px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }
        .msg {
            max-width: 80%;
            padding: 16px 24px;
            border-radius: 24px;
            line-height: 1.6;
        }
        .user { align-self: flex-end; background: linear-gradient(135deg, #0066ff, #00aaff); border-bottom-right-radius: 8px; }
        .ai { align-self: flex-start; background: rgba(0,224,255,0.25); border: 1px solid rgba(0,224,255,0.4); border-bottom-left-radius: 8px; }

        .input-bar {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        #input {
            flex: 1;
            padding: 18px 24px;
            border-radius: 50px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }

        #mindmap-container {
            margin: 40px 0;
            background: linear-gradient(145deg, rgba(0,0,0,0.5) 0%, rgba(0,20,40,0.4) 50%, rgba(10,30,60,0.5) 100%);
            border-radius: 36px;
            padding: 36px;
            display: none;
            border: 1.5px solid rgba(0,224,255,0.25);
            box-shadow:
                0 0 60px rgba(0,224,255,0.18),
                0 0 120px rgba(0,150,255,0.12),
                inset 0 2px 0 rgba(255,255,255,0.12),
                inset 0 -2px 0 rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        /* å®¹å™¨å…‰æ•ˆè£…é¥° */
        #mindmap-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 30% 20%, rgba(0,224,255,0.08) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(99, 102, 241, 0.06) 0%, transparent 50%);
            pointer-events: none;
            animation: containerGlow 8s ease-in-out infinite;
        }

        @keyframes containerGlow {
            0%, 100% { opacity: 0.5; transform: translate(0, 0) scale(1); }
            50% { opacity: 1; transform: translate(2%, 2%) scale(1.02); }
        }

        #mindmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            flex-wrap: wrap;
            gap: 20px;
            padding: 24px 28px;
            background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%);
            border-radius: 24px;
            border: 1px solid rgba(0,224,255,0.2);
            position: relative;
            z-index: 1;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.08),
                        0 4px 20px rgba(0,0,0,0.15);
        }

        #mindmap-title {
            font-size: 1.65rem;
            font-weight: 750;
            background: linear-gradient(135deg, #00e0ff 0%, #00ffff 50%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 14px;
            letter-spacing: 0.8px;
            filter: drop-shadow(0 0 12px rgba(0,224,255,0.4));
        }

        #mindmap-title::before {
            content: 'ğŸ§ ';
            font-size: 1.8rem;
            filter: drop-shadow(0 0 12px rgba(0,224,255,0.8));
            animation: brainPulse 3s ease-in-out infinite;
        }

        @keyframes brainPulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 12px rgba(0,224,255,0.8)); }
            50% { transform: scale(1.08); filter: drop-shadow(0 0 18px rgba(0,224,255,1)); }
        }

        #mindmap-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        #mindmap-actions .btn-small {
            padding: 10px 18px;
            font-size: 0.85rem;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(0,102,255,0.75) 0%, rgba(0,224,255,0.75) 100%);
            border: 1px solid rgba(0,224,255,0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,102,255,0.25),
                        inset 0 1px 0 rgba(255,255,255,0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #mindmap-actions .btn-small:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,102,255,0.35),
                        inset 0 1px 0 rgba(255,255,255,0.3);
            background: linear-gradient(135deg, rgba(0,102,255,0.85) 0%, rgba(0,224,255,0.85) 100%);
        }

        #mindmap-actions .btn-small:active {
            transform: translateY(-1px) scale(1.02);
        }

        #markmap {
            width: 100%;
            height: 850px;
            background: linear-gradient(180deg, rgba(255,255,255,0.998) 0%, rgba(248,250,252,0.995) 50%, rgba(243,245,249,0.99) 100%);
            border-radius: 32px;
            overflow: hidden;
            position: relative;
            box-shadow:
                inset 0 6px 24px rgba(99, 102, 241, 0.08),
                inset 0 2px 6px rgba(0,0,0,0.02),
                0 8px 32px rgba(0,0,0,0.12),
                0 2px 8px rgba(0,0,0,0.06);
            border: 1.5px solid rgba(99, 102, 241, 0.12);
            z-index: 1;
        }

        #markmap::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(99, 102, 241, 0.4) 15%,
                rgba(168, 85, 247, 0.5) 50%,
                rgba(99, 102, 241, 0.4) 85%,
                transparent 100%);
            z-index: 10;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
        }

        /* åº•éƒ¨å…‰æ•ˆ */
        #markmap::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 1px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(99, 102, 241, 0.3) 30%,
                rgba(168, 85, 247, 0.35) 50%,
                rgba(99, 102, 241, 0.3) 70%,
                transparent 100%);
            z-index: 10;
        }
        #markmap svg {
            width: 100% !important;
            height: 100% !important;
        }
        /* æ–‡æœ¬æ¨¡å¼ - ç²‰è‰²ä¼˜é›…ä¸»é¢˜ */
        #markmap pre {
            margin: 0;
            border-radius: 18px;
            overflow: auto;
            max-height: 780px;
            background: linear-gradient(145deg,
                rgba(255, 252, 253, 0.98) 0%,
                rgba(253, 242, 248, 0.97) 50%,
                rgba(252, 236, 245, 0.96) 100%);
            padding: 28px 32px;
            font-family: 'Inter', 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            line-height: 1.9;
            color: #831843;
            border: 1.5px solid rgba(236, 72, 153, 0.2);
            box-shadow:
                0 8px 24px rgba(236, 72, 153, 0.12),
                0 4px 12px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.02);
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }

        /* æ–‡æœ¬æ¨¡å¼æ»šåŠ¨æ¡ç¾åŒ– */
        #markmap pre::-webkit-scrollbar {
            width: 12px;
        }

        #markmap pre::-webkit-scrollbar-track {
            background: linear-gradient(180deg,
                rgba(252, 236, 245, 0.8) 0%,
                rgba(251, 207, 232, 0.7) 100%);
            border-radius: 6px;
            border: 1px solid rgba(236, 72, 153, 0.15);
        }

        #markmap pre::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg,
                #f472b6 0%,
                #ec4899 50%,
                #db2777 100%);
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 6px rgba(236, 72, 153, 0.25);
        }

        #markmap pre::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg,
                #ec4899 0%,
                #db2777 50%,
                #be185d 100%);
        }

        /* Markdown å…ƒç´ æ ·å¼å¢å¼º */
        #markmap pre code {
            font-family: 'Inter', 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #831843;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.6);
        }

        /* é¡¶éƒ¨è£…é¥°æ¡ - ç²‰è‰²æ¸å˜ */
        #markmap pre::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg,
                #f472b6 0%,
                #ec4899 50%,
                #db2777 100%);
            border-radius: 18px 18px 0 0;
        }

        /* ==================== æ€ç»´å¯¼å›¾ç²‰è‰²ä¼˜é›…ä¸»é¢˜ ==================== */

        /* åŸºç¡€SVGèƒŒæ™¯ - ç²‰è‰²æ¸©é¦¨ */
        #markmap svg {
            background: linear-gradient(180deg,
                rgba(255, 250, 252, 0.99) 0%,
                rgba(253, 242, 248, 0.98) 50%,
                rgba(252, 236, 245, 0.97) 100%);
            background-image:
                radial-gradient(circle at 50% 0%, rgba(236, 72, 153, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 50% 100%, rgba(244, 114, 182, 0.025) 0%, transparent 50%),
                radial-gradient(circle, rgba(236, 72, 153, 0.12) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 22px 22px;
            border-radius: 28px;
            position: relative;
        }

        /* èŠ‚ç‚¹æ ·å¼ - ç²‰è‰²ä¼˜é›…å¡ç‰‡ */
        #markmap g.markmap-node {
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #markmap g.markmap-node rect {
            rx: 18;
            ry: 18;
            stroke-width: 1.5;
            stroke: rgba(236, 72, 153, 0.25);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 4px 16px rgba(236, 72, 153, 0.1))
                    drop-shadow(0 2px 8px rgba(0, 0, 0, 0.05));
            background: linear-gradient(145deg, #ffffff 0%, #fdf2f8 100%);
        }

        #markmap g.markmap-node:hover {
            transform: translateY(-4px) scale(1.02);
        }

        #markmap g.markmap-node:hover rect {
            stroke: rgba(236, 72, 153, 0.5);
            stroke-width: 2;
            filter: drop-shadow(0 8px 24px rgba(236, 72, 153, 0.18))
                    drop-shadow(0 4px 12px rgba(0, 0, 0, 0.08));
            background: linear-gradient(145deg, #ffffff 0%, #fce7f3 100%);
        }

        /* æ ¹èŠ‚ç‚¹ç‰¹æ®Šæ ·å¼ - ç²‰çº¢æ¸å˜å¼ºè°ƒ */
        #markmap g.markmap-node[data-depth="0"] rect {
            rx: 22;
            ry: 22;
            stroke-width: 2;
            stroke: rgba(255, 255, 255, 0.6);
            filter: drop-shadow(0 8px 24px rgba(236, 72, 153, 0.3))
                    drop-shadow(0 4px 12px rgba(244, 114, 182, 0.2));
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 50%, #fb7185 100%);
        }

        #markmap g.markmap-node[data-depth="0"]:hover rect {
            filter: drop-shadow(0 12px 32px rgba(236, 72, 153, 0.4))
                    drop-shadow(0 6px 16px rgba(244, 114, 182, 0.3));
            background: linear-gradient(135deg, #db2777 0%, #ec4899 50%, #f43f5e 100%);
        }

        /* ä¸€çº§èŠ‚ç‚¹æ ·å¼ - ç²‰è‰²è¾¹æ¡† */
        #markmap g.markmap-node[data-depth="1"] rect {
            rx: 20;
            ry: 20;
            stroke-width: 1.6;
            stroke: rgba(236, 72, 153, 0.3);
            filter: drop-shadow(0 5px 18px rgba(236, 72, 153, 0.12))
                    drop-shadow(0 2px 8px rgba(0, 0, 0, 0.05));
            background: linear-gradient(145deg, #ffffff 0%, #fdf2f8 100%);
        }

        #markmap g.markmap-node[data-depth="1"]:hover rect {
            stroke: rgba(236, 72, 153, 0.55);
            filter: drop-shadow(0 8px 24px rgba(236, 72, 153, 0.2))
                    drop-shadow(0 4px 12px rgba(0, 0, 0, 0.08));
        }

        /* äºŒçº§èŠ‚ç‚¹æ ·å¼ */
        #markmap g.markmap-node[data-depth="2"] rect {
            rx: 17;
            ry: 17;
            stroke-width: 1.4;
            stroke: rgba(244, 114, 182, 0.25);
            filter: drop-shadow(0 4px 12px rgba(244, 114, 182, 0.1))
                    drop-shadow(0 2px 6px rgba(0, 0, 0, 0.04));
            background: linear-gradient(145deg, #ffffff 0%, #fdf2f8 100%);
        }

        /* ä¸‰çº§åŠä»¥ä¸‹èŠ‚ç‚¹ */
        #markmap g.markmap-node[data-depth="3"] rect,
        #markmap g.markmap-node[data-depth="4"] rect {
            rx: 15;
            ry: 15;
            stroke-width: 1.2;
            stroke: rgba(251, 113, 133, 0.2);
            filter: drop-shadow(0 3px 10px rgba(251, 113, 133, 0.08))
                    drop-shadow(0 1px 4px rgba(0, 0, 0, 0.03));
            background: linear-gradient(145deg, #ffffff 0%, #fef2f2 100%);
        }

        /* è¿çº¿æ ·å¼ - ç®€æ´ä¼˜é›… */
        #markmap path.markmap-link {
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.3s ease;
            opacity: 0.35;
            stroke-width: 2;
        }

        #markmap path.markmap-link:hover {
            stroke-width: 3 !important;
            opacity: 0.6;
        }

        /* æ–‡å­—æ ·å¼ - ç²‰è‰²ä¼˜é›… */
        #markmap text {
            font-family: 'Inter', 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif !important;
            fill: #831843 !important;
            text-shadow:
                0 1px 1px rgba(255,255,255,0.8),
                0 0 1px rgba(255,255,255,0.5);
            font-weight: 580;
            letter-spacing: 0.3px;
            pointer-events: none;
            transition: all 0.2s ease;
            paint-order: stroke fill;
            stroke: rgba(255,255,255,0.3);
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* æ ¹èŠ‚ç‚¹æ–‡å­— - ç™½è‰²é«˜å¯¹æ¯” */
        #markmap g.markmap-node[data-depth="0"] text {
            fill: #ffffff !important;
            text-shadow:
                0 2px 4px rgba(131, 24, 67, 0.3),
                0 1px 2px rgba(0, 0, 0, 0.15);
            font-weight: 700;
            letter-spacing: 0.5px;
            stroke: rgba(131,24,67,0.1);
            stroke-width: 0.5px;
        }

        /* ä¸€çº§èŠ‚ç‚¹æ–‡å­— - æ·±ç²‰çº¢ */
        #markmap g.markmap-node[data-depth="1"] text {
            fill: #9d174d !important;
            font-weight: 620;
            letter-spacing: 0.35px;
        }

        /* äºŒçº§åŠä»¥ä¸‹èŠ‚ç‚¹æ–‡å­— */
        #markmap g.markmap-node[data-depth="2"] text,
        #markmap g.markmap-node[data-depth="3"] text {
            fill: #be185d !important;
            font-weight: 560;
            letter-spacing: 0.25px;
        }

        #markmap g.markmap-node:hover text {
            fill: #831843 !important;
            text-shadow:
                0 1px 2px rgba(255,255,255,0.9),
                0 0 2px rgba(255,255,255,0.6);
            stroke: rgba(255,255,255,0.4);
            stroke-width: 4px;
        }

        /* æ ¹èŠ‚ç‚¹æ‚¬åœæ–‡å­— */
        #markmap g.markmap-node[data-depth="0"]:hover text {
            text-shadow:
                0 2px 6px rgba(131, 24, 67, 0.35),
                0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* æ·»åŠ åŠ è½½åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .mindmap-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 10;
        }
        .mindmap-loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0,224,255,0.2);
            border-top-color: #00e0ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .mindmap-loader-text {
            color: #00e0ff;
            font-size: 0.95rem;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 60px;
        }
        .tool-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            text-align: center;
            box-shadow: var(--glow);
            transition: 0.4s;
        }
        .tool-card:hover { transform: translateY(-12px); }
        .tool-card img { width: 100px; height: 100px; border-radius: 16px; margin-bottom: 16px; object-fit: cover; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>aipdfl.com</h1>
            <p style="font-size:1.4rem; opacity:0.9;">2025 ç»ˆæçœŸAI PDFå¹³å° Â· å®‰å…¨åç«¯é©±åŠ¨</p>
        </header>

        <div class="main-card">
            <div class="upload-bar">
                <label class="btn">é€‰æ‹©PDFï¼ˆæ”¯æŒå¤šé€‰ï¼‰<input type="file" id="pdf-input" accept=".pdf" multiple></label>
                <button class="btn" onclick="uploadPDFs()">ä¸Šä¼ å¹¶åˆ†æ</button>
                <button class="btn" onclick="generateMindmap()">ç”Ÿæˆæ€ç»´å¯¼å›¾</button>
                <button class="btn" onclick="shareChat()">åˆ†äº«èŠå¤©è®°å½•</button>
                <button class="btn btn-voice" onclick="startVoice()">è¯­éŸ³æé—®</button>
            </div>

            <div id="file-list"></div>

            <div id="preview"></div>

            <div id="mindmap-container">
                <div id="mindmap-header">
                    <div id="mindmap-title">æ€ç»´å¯¼å›¾</div>
                    <div id="mindmap-actions">
                        <button class="btn btn-small" onclick="zoomIn()">ğŸ”+</button>
                        <button class="btn btn-small" onclick="zoomOut()">ğŸ”-</button>
                        <button class="btn btn-small" onclick="resetZoom()">â†º</button>
                        <button class="btn btn-small" onclick="toggleFullscreen()">â›¶ å…¨å±</button>
                        <button class="btn btn-small" onclick="exportMindmap('png')">ğŸ“· PNG</button>
                        <button class="btn btn-small" onclick="exportMindmap('svg')">ğŸ“„ SVG</button>
                    </div>
                </div>
                <div id="markmap"></div>
            </div>

            <div id="chat"></div>

            <div class="input-bar">
                <input type="text" id="input" placeholder="å‘AIæé—®...ï¼ˆå›è½¦å‘é€ï¼‰">
                <button class="btn" onclick="send()">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        // PDF.js 3.x å…¨å±€å˜é‡é…ç½®
        const pdfjsLib = window.pdfjsLib;
        if (pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        let files = [];
        let currentFileIndex = 0;
        let sessionId = null;
        let chatHistory = [];
        let currentMindmapData = null;  // å­˜å‚¨å½“å‰æ€ç»´å¯¼å›¾æ•°æ® (markmapæ ¼å¼)
        let currentMindmapMarkdown = '';  // å­˜å‚¨åŸå§‹markdown

        // å›¾æ ‡æ˜ å°„ - æ ¹æ®å…³é”®è¯åŒ¹é…å¯¹åº”çš„emojiå›¾æ ‡ï¼ˆå¢å¼ºç‰ˆï¼‰
        const iconMap = {
            // ==================== é€šç”¨ä¸»é¢˜ ====================
            'ä¸»é¢˜': 'ğŸ¯', 'ä¸­å¿ƒ': 'ğŸ¯', 'æ ¸å¿ƒ': 'ğŸ¯', 'ç›®æ ‡': 'ğŸ¯', 'ç„¦ç‚¹': 'ğŸ¯',
            'æ¦‚è¿°': 'ğŸ“‹', 'ç®€ä»‹': 'ğŸ“‹', 'ä»‹ç»': 'ğŸ“‹', 'æ‘˜è¦': 'ğŸ“', 'æ¦‚è¦': 'ğŸ“‹',
            'æ€»ç»“': 'ğŸ“', 'ç»“è®º': 'ğŸ¯', 'è¦ç‚¹': 'ğŸ”‘', 'å…³é”®ç‚¹': 'ğŸ”‘',
            'èƒŒæ™¯': 'ğŸ–¼ï¸', 'å‰è¨€': 'ğŸ“œ', 'åºè¨€': 'ğŸ“œ',

            // ==================== ä¸šåŠ¡/å•†ä¸š ====================
            'ä¸šåŠ¡': 'ğŸ’¼', 'å•†ä¸š': 'ğŸ’¼', 'å•†åŠ¡': 'ğŸ’¼', 'ä¼ä¸š': 'ğŸ¢', 'å…¬å¸': 'ğŸ¢',
            'å¸‚åœº': 'ğŸ“Š', 'è¥é”€': 'ğŸ“¢', 'æ¨å¹¿': 'ğŸ“£', 'å®£ä¼ ': 'ğŸ“¢',
            'é”€å”®': 'ğŸ’°', 'è¥æ”¶': 'ğŸ’°', 'æ”¶å…¥': 'ğŸ’µ', 'åˆ©æ¶¦': 'ğŸ’', 'ç›ˆåˆ©': 'ğŸ’°',
            'æˆæœ¬': 'ğŸ’¸', 'è´¹ç”¨': 'ğŸ’³', 'é¢„ç®—': 'ğŸ’°', 'æŠ•èµ„': 'ğŸ“ˆ',
            'å®¢æˆ·': 'ğŸ‘¥', 'ç”¨æˆ·': 'ğŸ‘¤', 'æ¶ˆè´¹è€…': 'ğŸ›’', 'é¡¾å®¢': 'ğŸ§‘',
            'äº§å“': 'ğŸ“¦', 'å•†å“': 'ğŸ›ï¸', 'æœåŠ¡': 'ğŸ›ï¸', 'è§£å†³æ–¹æ¡ˆ': 'ğŸ’¡',
            'å“ç‰Œ': 'ğŸ·ï¸', 'æ¸ é“': 'ğŸ›’', 'ä¾›åº”é“¾': 'ğŸ”—',

            // ==================== æŠ€æœ¯/å¼€å‘ ====================
            'æŠ€æœ¯': 'âš™ï¸', 'å¼€å‘': 'ğŸ’»', 'ç¼–ç¨‹': 'ğŸ‘¨â€ğŸ’»', 'ä»£ç ': 'ğŸ’»',
            'ç³»ç»Ÿ': 'ğŸ–¥ï¸', 'å¹³å°': 'ğŸŒ', 'æ¶æ„': 'ğŸ—ï¸', 'æ¡†æ¶': 'ğŸ”§',
            'æ•°æ®': 'ğŸ“Š', 'ä¿¡æ¯': 'â„¹ï¸', 'å†…å®¹': 'ğŸ“„',
            'ç®—æ³•': 'ğŸ§®', 'æ¨¡å‹': 'ğŸ¤–', 'è®¡ç®—': 'ğŸ”¢', 'å¤„ç†': 'âš™ï¸',
            'AI': 'ğŸ¤–', 'äººå·¥æ™ºèƒ½': 'ğŸ¤–', 'æ™ºèƒ½': 'ğŸ§ ', 'æœºå™¨å­¦ä¹ ': 'ğŸ§ ', 'æ·±åº¦å­¦ä¹ ': 'ğŸ”¬',
            'å‰ç«¯': 'ğŸ¨', 'åç«¯': 'âš¡', 'å…¨æ ˆ': 'ğŸ”·', 'æ•°æ®åº“': 'ğŸ—„ï¸', 'API': 'ğŸ”Œ',
            'äº‘': 'â˜ï¸', 'æœåŠ¡å™¨': 'ğŸ–¥ï¸', 'ç½‘ç»œ': 'ğŸŒ', 'äº’è”ç½‘': 'ğŸŒ',
            'ç§»åŠ¨': 'ğŸ“±', 'APP': 'ğŸ“±', 'åº”ç”¨': 'ğŸ“±', 'è½¯ä»¶': 'ğŸ’»',
            'å®‰å…¨': 'ğŸ”’', 'åŠ å¯†': 'ğŸ”', 'è®¤è¯': 'ğŸ”‘', 'æƒé™': 'ğŸ«',
            'æµ‹è¯•': 'ğŸ§ª', 'è°ƒè¯•': 'ğŸ›', 'bug': 'ğŸ›', 'é”™è¯¯': 'âŒ', 'å¼‚å¸¸': 'âš ï¸',
            'éƒ¨ç½²': 'ğŸš€', 'å‘å¸ƒ': 'ğŸ“¢', 'ç‰ˆæœ¬': 'ğŸ·ï¸', 'æ›´æ–°': 'ğŸ”„',
            'æ€§èƒ½': 'âš¡', 'ä¼˜åŒ–': 'ğŸš€', 'æ•ˆç‡': 'â±ï¸', 'é€Ÿåº¦': 'ğŸ’¨',

            // ==================== å­¦ä¹ /æ•™è‚² ====================
            'å­¦ä¹ ': 'ğŸ“š', 'æ•™è‚²': 'ğŸ“', 'åŸ¹è®­': 'ğŸ“–', 'è¯¾ç¨‹': 'ğŸ“š', 'æ•™å­¦': 'ğŸ‘¨â€ğŸ«',
            'çŸ¥è¯†': 'ğŸ’¡', 'ç†è®º': 'ğŸ“–', 'æ¦‚å¿µ': 'ğŸ’­', 'å®šä¹‰': 'ğŸ“',
            'æŠ€èƒ½': 'ğŸ”§', 'èƒ½åŠ›': 'â­', 'ç´ å…»': 'ğŸŒŸ', 'ä¸“é•¿': 'ğŸ¯',
            'è€ƒè¯•': 'âœï¸', 'æµ‹è¯•': 'âœ…', 'ä½œä¸š': 'ğŸ“', 'ç»ƒä¹ ': 'ğŸ‹ï¸',
            'å­¦æ ¡': 'ğŸ«', 'å¤§å­¦': 'ğŸ“', 'å­¦é™¢': 'ğŸ›ï¸', 'å›¾ä¹¦é¦†': 'ğŸ“š',
            'å­¦ç”Ÿ': 'ğŸ‘¨â€ğŸ“', 'è€å¸ˆ': 'ğŸ‘¨â€ğŸ«', 'æ•™æˆ': 'ğŸ‘¨â€ğŸ«',

            // ==================== é¡¹ç›®/è®¡åˆ’ ====================
            'é¡¹ç›®': 'ğŸ“', 'å·¥ç¨‹': 'ğŸ—ï¸', 'è®¡åˆ’': 'ğŸ“…', 'è§„åˆ’': 'ğŸ—ºï¸',
            'ä»»åŠ¡': 'âœ…', 'å·¥ä½œ': 'ğŸ’¼', 'æ´»åŠ¨': 'ğŸ‰', 'äº‹ä»¶': 'ğŸ“…',
            'è¿›åº¦': 'ğŸ“ˆ', 'çŠ¶æ€': 'ğŸ“Š', 'é˜¶æ®µ': 'ğŸš©', 'é‡Œç¨‹ç¢‘': 'ğŸ',
            'æ—¶é—´': 'â°', 'æ—¥æœŸ': 'ğŸ“…', 'æœŸé™': 'â³', 'å‘¨æœŸ': 'ğŸ”„',
            'å¼€å§‹': 'ğŸš€', 'å¯åŠ¨': 'ğŸš€', 'å¯åŠ¨': 'â–¶ï¸', 'è¿›è¡Œ': 'â¯ï¸',
            'å®Œæˆ': 'ğŸ', 'ç»“æŸ': 'ğŸ', 'å…³é—­': 'ğŸ”š', 'ç»ˆæ­¢': 'ğŸ›‘',
            'é‡Œç¨‹ç¢‘': 'ğŸš©', 'èŠ‚ç‚¹': 'ğŸ“', 'æ£€æŸ¥ç‚¹': 'ğŸ”',

            // ==================== é—®é¢˜/è§£å†³ ====================
            'é—®é¢˜': 'â“', 'ç–‘é—®': 'â“', 'å›°æƒ‘': 'ğŸ¤”', 'éš¾ç‚¹': 'â›°ï¸',
            'æŒ‘æˆ˜': 'âš ï¸', 'é£é™©': 'ğŸš¨', 'å±æœº': 'ğŸ†˜', 'å¨èƒ': 'âš¡',
            'å›°éš¾': 'ğŸ”´', 'éšœç¢': 'ğŸš§', 'é˜»ç¢': 'ğŸ›‘', 'é™åˆ¶': 'ğŸš§',
            'è§£å†³': 'âœ…', 'æ–¹æ¡ˆ': 'ğŸ’¡', 'ç­”æ¡ˆ': 'ğŸ”‘', 'å¯¹ç­–': 'ğŸ›¡ï¸',
            'æ–¹æ³•': 'ğŸ”§', 'ç­–ç•¥': 'â™Ÿï¸', 'æŠ€å·§': 'ğŸ¯', 'çªé—¨': 'ğŸ’¡',
            'ä¼˜ç‚¹': 'âœ…', 'ä¼˜åŠ¿': 'â­', 'ç‰¹è‰²': 'ğŸ’', 'äº®ç‚¹': 'âœ¨',
            'ç¼ºç‚¹': 'âŒ', 'åŠ£åŠ¿': 'âš ï¸', 'ä¸è¶³': 'ğŸ“‰', 'å¼±ç‚¹': 'ğŸ’”',
            'å½±å“': 'ğŸŒŠ', 'åæœ': 'ğŸ“Œ', 'ç»“æœ': 'ğŸ“Š', 'æˆæœ': 'ğŸ†',

            // ==================== åˆ†æ/ç ”ç©¶ ====================
            'åˆ†æ': 'ğŸ”', 'ç ”ç©¶': 'ğŸ”¬', 'æ¢ç´¢': 'ğŸ§­', 'è°ƒç ”': 'ğŸ“‹',
            'è°ƒæŸ¥': 'ğŸ“Š', 'ç»Ÿè®¡': 'ğŸ“ˆ', 'æµ‹é‡': 'ğŸ“', 'è¯„ä¼°': 'ğŸ“Š',
            'æŠ¥å‘Š': 'ğŸ“„', 'æ–‡æ¡£': 'ğŸ“‹', 'è®ºæ–‡': 'ğŸ“œ', 'æ–‡ç« ': 'ğŸ“',
            'è®°å½•': 'ğŸ“', 'æ—¥å¿—': 'ğŸ““', 'æ¡£æ¡ˆ': 'ğŸ—„ï¸', 'èµ„æ–™': 'ğŸ“š',
            'å‘ç°': 'ğŸ”', 'ç»“æœ': 'ğŸ“Š', 'ç»“è®º': 'ğŸ¯', 'æˆæœ': 'ğŸ†',
            'å‡è®¾': 'ğŸ’­', 'çŒœæƒ³': 'ğŸ¤”', 'é¢„æµ‹': 'ğŸ”®', 'æ¨æµ‹': 'ğŸ§ ',
            'å®éªŒ': 'ğŸ§ª', 'éªŒè¯': 'âœ…', 'è¯æ˜': 'ğŸ“œ', 'è¯æ®': 'ğŸ”—',

            // ==================== åˆ›æ„/è®¾è®¡ ====================
            'è®¾è®¡': 'ğŸ¨', 'åˆ›æ„': 'ğŸ’¡', 'åˆ›æ–°': 'âœ¨', 'åˆ›é€ ': 'ğŸ­',
            'çµæ„Ÿ': 'âš¡', 'æƒ³è±¡': 'ğŸŒˆ', 'æ„æ€': 'ğŸ’­',
            'ç•Œé¢': 'ğŸ–¼ï¸', 'UI': 'ğŸ¨', 'UX': 'ğŸ˜Š', 'äº¤äº’': 'ğŸ‘†',
            'ä½“éªŒ': 'ğŸ˜Š', 'æ„Ÿå—': 'â¤ï¸', 'å°è±¡': 'ğŸ’«',
            'é¢œè‰²': 'ğŸŒˆ', 'è‰²å½©': 'ğŸ¨', 'é£æ ¼': 'ğŸ­', 'æ ·å¼': 'ğŸ‘—',
            'ä¸»é¢˜': 'ğŸ¨', 'æ¨¡æ¿': 'ğŸ“‹', 'å¸ƒå±€': 'ğŸ“', 'æ’ç‰ˆ': 'ğŸ“',
            'å›¾å½¢': 'ğŸ”·', 'å›¾åƒ': 'ğŸ–¼ï¸', 'å›¾æ ‡': 'ğŸ”¶', 'ç¬¦å·': 'ğŸ”£',

            // ==================== æ—¶é—´/æµç¨‹ ====================
            'æµç¨‹': 'ğŸ”„', 'è¿‡ç¨‹': 'â³', 'æ­¥éª¤': 'ğŸ‘£', 'ç¯èŠ‚': 'ğŸ”—',
            'ç¨‹åº': 'ğŸ“‹', 'é¡ºåº': 'ğŸ”¢', 'åºåˆ—': 'ğŸ”—', 'é˜Ÿåˆ—': 'ğŸš¶',
            'å†å²': 'ğŸ“œ', 'è¿‡å»': 'â®ï¸', 'ç°åœ¨': 'â¯ï¸', 'æœªæ¥': 'ğŸ”®',
            'è¶‹åŠ¿': 'ğŸ“ˆ', 'å‘å±•': 'ğŸš€', 'æ¼”è¿›': 'ğŸ”„', 'å˜åŒ–': 'ğŸ¦‹',
            'å‘¨æœŸ': 'ğŸ”„', 'é¢‘ç‡': 'ğŸ“Š', 'é—´éš”': 'â¸ï¸', 'æŒç»­': 'â™¾ï¸',

            // ==================== åˆ†ç±»/ç±»å‹ ====================
            'ç±»å‹': 'ğŸ·ï¸', 'åˆ†ç±»': 'ğŸ“‚', 'ç§ç±»': 'ğŸ—‚ï¸', 'ç±»åˆ«': 'ğŸ“',
            'å½¢å¼': 'ğŸ“‹', 'æ¨¡å¼': 'ğŸ”²', 'æ–¹å¼': 'ğŸ›¤ï¸', 'é€”å¾„': 'ğŸ›£ï¸',
            'ä¾‹å­': 'ğŸ’¡', 'æ¡ˆä¾‹': 'ğŸ“–', 'ç¤ºä¾‹': 'ğŸ“', 'å®ä¾‹': 'ğŸ”·',
            'åŒ…æ‹¬': 'â•', 'åŒ…å«': 'â•', 'ä»¥åŠ': 'â•', 'è¿˜æœ‰': 'â•',
            'ç»„æˆ': 'ğŸ§©', 'æ„æˆ': 'ğŸ”—', 'éƒ¨åˆ†': 'ğŸ§©', 'æˆå‘˜': 'ğŸ‘¥',

            // ==================== æ•°é‡/ç¨‹åº¦ ====================
            'å¢åŠ ': 'ğŸ“ˆ', 'æå‡': 'â¬†ï¸', 'æé«˜': 'ğŸ“ˆ', 'æ”¹å–„': 'âœ¨', 'ä¼˜åŒ–': 'ğŸš€',
            'å‡å°‘': 'ğŸ“‰', 'é™ä½': 'â¬‡ï¸', 'ä¸‹é™': 'ğŸ“‰', 'èŠ‚çœ': 'ğŸ’°',
            'ä¿æŒ': 'â¸ï¸', 'ç»´æŒ': 'â¸ï¸', 'ç¨³å®š': 'â¡ï¸', 'ä¸å˜': 'ğŸ”’',
            'å…¨éƒ¨': 'ğŸ”˜', 'æ‰€æœ‰': 'ğŸ”˜', 'æ•´ä½“': 'ğŸ”˜', 'å®Œå…¨': 'âœ…',
            'éƒ¨åˆ†': 'âšª', 'å±€éƒ¨': 'âšª', 'æŸäº›': 'ğŸ”µ',
            'å¤šæ•°': 'ğŸ”µ', 'å¤§å¤šæ•°': 'ğŸ”µ', 'å°‘æ•°': 'ğŸ”¸', 'ä¸ªåˆ«': 'ğŸ”¸',
            'æœ€å¤§': 'â¬†ï¸', 'æœ€å°': 'â¬‡ï¸', 'å¹³å‡': 'âš–ï¸', 'æ€»è®¡': 'ğŸ”¢',

            // ==================== æƒ…æ„Ÿ/æ€åº¦ ====================
            'é‡è¦': 'â­', 'å…³é”®': 'ğŸ”‘', 'æ ¸å¿ƒ': 'ğŸ’', 'ä¸»è¦': 'ğŸ”´', 'é¦–è¦': 'ğŸ¥‡',
            'æ¬¡è¦': 'âšª', 'è¾…åŠ©': 'ğŸ”µ', 'è¡¥å……': 'â•', 'é™„åŠ ': 'â•',
            'ç§¯æ': 'ğŸ˜Š', 'æ­£é¢': 'âœ…', 'è‚¯å®š': 'ğŸ‘', 'æ”¯æŒ': 'ğŸ¤',
            'æ¶ˆæ': 'ğŸ˜', 'è´Ÿé¢': 'âŒ', 'åå¯¹': 'ğŸ‘', 'æ‹’ç»': 'ğŸš«',
            'ä¸­æ€§': 'â¡ï¸', 'å®¢è§‚': 'âš–ï¸', 'å…¬æ­£': 'âš–ï¸',
            'å–œæ¬¢': 'â¤ï¸', 'çˆ±': 'ğŸ’•', 'è®¨åŒ': 'ğŸ’”', 'æ¨': 'ğŸ˜¡',
            'æ»¡æ„': 'ğŸ˜Š', 'å¼€å¿ƒ': 'ğŸ˜„', 'å¿«ä¹': 'ğŸ‰', 'å¹¸ç¦': 'ğŸ’–',
            'ä¸æ»¡æ„': 'ğŸ˜', 'éš¾è¿‡': 'ğŸ˜¢', 'æ‚²ä¼¤': 'ğŸ˜­', 'ç—›è‹¦': 'ğŸ˜£',

            // ==================== å·¥å…·/èµ„æº ====================
            'å·¥å…·': 'ğŸ”§', 'è½¯ä»¶': 'ğŸ’»', 'ç¡¬ä»¶': 'âš™ï¸', 'è®¾å¤‡': 'ğŸ“±',
            'èµ„æº': 'ğŸ“¦', 'ææ–™': 'ğŸ“„', 'ç´ æ': 'ğŸ¨', 'åŸæ–™': 'ğŸ§±',
            'ä¿¡æ¯': 'â„¹ï¸', 'æ¶ˆæ¯': 'ğŸ“¨', 'æ–°é—»': 'ğŸ“°', 'èµ„è®¯': 'ğŸ“Š',
            'æ–‡ä»¶': 'ğŸ“„', 'æ–‡æ¡£': 'ğŸ“‹', 'èµ„æ–™': 'ğŸ“š', 'æ¡£æ¡ˆ': 'ğŸ—„ï¸',
            'æ•°æ®': 'ğŸ“Š', 'æ•°æ®åº“': 'ğŸ—„ï¸', 'å­˜å‚¨': 'ğŸ’¾', 'å¤‡ä»½': 'ğŸ’¿',

            // ==================== ç½‘ç»œ/è¿æ¥ ====================
            'ç½‘ç»œ': 'ğŸŒ', 'äº’è”ç½‘': 'ğŸŒ', 'ç½‘': 'ğŸ•¸ï¸',
            'è¿æ¥': 'ğŸ”—', 'é“¾æ¥': 'ğŸ”—', 'å…³è”': 'ğŸ”—', 'å…³ç³»': 'ğŸ¤',
            'åœ¨çº¿': 'ğŸŸ¢', 'ç¦»çº¿': 'ğŸ”´', 'ä¸Šç½‘': 'ğŸŒ', 'æµè§ˆ': 'ğŸ‘€',
            'ç½‘ç«™': 'ğŸŒ', 'ç½‘é¡µ': 'ğŸ“„', 'é¡µé¢': 'ğŸ“„', 'ä¸»é¡µ': 'ğŸ ',
            'æœç´¢': 'ğŸ”', 'æŸ¥æ‰¾': 'ğŸ”', 'æ£€ç´¢': 'ğŸ”',

            // ==================== å®‰å…¨/ä¿æŠ¤ ====================
            'å®‰å…¨': 'ğŸ”’', 'ä¿æŠ¤': 'ğŸ›¡ï¸', 'é˜²æŠ¤': 'ğŸ›¡ï¸', 'é˜²å¾¡': 'ğŸ°',
            'éšç§': 'ğŸ”', 'ä¿å¯†': 'ğŸ”', 'æœºå¯†': 'ğŸ”’',
            'æƒé™': 'ğŸ”‘', 'è®¸å¯': 'ğŸ«', 'è®¤è¯': 'âœ…', 'æˆæƒ': 'ğŸ“œ',
            'å¤‡ä»½': 'ğŸ’¾', 'æ¢å¤': 'â™»ï¸', 'è¿˜åŸ': 'â†©ï¸', 'æ’¤é”€': 'â†©ï¸',
            'åˆ é™¤': 'ğŸ—‘ï¸', 'æ¸…é™¤': 'ğŸ§¹', 'ç§»é™¤': 'âŒ',

            // ==================== é€šä¿¡/åä½œ ====================
            'æ²Ÿé€š': 'ğŸ’¬', 'äº¤æµ': 'ğŸ—£ï¸', 'å¯¹è¯': 'ğŸ’­', 'èŠå¤©': 'ğŸ’¬',
            'è®¨è®º': 'ğŸ’­', 'è¾©è®º': 'ğŸ—£ï¸', 'åå•†': 'ğŸ¤',
            'ä¼šè®®': 'ğŸ¤', 'èšä¼š': 'ğŸ‰', 'æ´»åŠ¨': 'ğŸŠ',
            'å›¢é˜Ÿ': 'ğŸ‘¥', 'å°ç»„': 'ğŸ‘¥', 'éƒ¨é—¨': 'ğŸ¢', 'ç»„ç»‡': 'ğŸ›ï¸',
            'åä½œ': 'ğŸ¤', 'åˆä½œ': 'ğŸ¤', 'é…åˆ': 'ğŸ¤', 'å…±èµ¢': 'ğŸ†',
            'åˆ†äº«': 'ğŸ“¤', 'å…±äº«': 'ğŸ”„', 'ä¼ æ’­': 'ğŸ“¡', 'å‘å¸ƒ': 'ğŸ“¢',

            // ==================== é‡‘è/è´¢åŠ¡ ====================
            'èµ„é‡‘': 'ğŸ’°', 'èµ„æœ¬': 'ğŸ’µ', 'èµ„äº§': 'ğŸ’', 'è´¢å¯Œ': 'ğŸ’°',
            'é“¶è¡Œ': 'ğŸ¦', 'è´·æ¬¾': 'ğŸ’³', 'ä¿¡ç”¨å¡': 'ğŸ’³',
            'è‚¡ç¥¨': 'ğŸ“ˆ', 'åŸºé‡‘': 'ğŸ’¼', 'å€ºåˆ¸': 'ğŸ“œ', 'æŠ•èµ„': 'ğŸ“Š',
            'æ±‡ç‡': 'ğŸ’±', 'è´§å¸': 'ğŸ’´', 'ç°é‡‘': 'ğŸ’µ', 'æ”¯ä»˜': 'ğŸ’³',

            // ==================== å¥åº·/åŒ»ç–— ====================
            'å¥åº·': 'â¤ï¸', 'åŒ»ç–—': 'âš•ï¸', 'åŒ»é™¢': 'ğŸ¥', 'åŒ»ç”Ÿ': 'ğŸ‘¨â€âš•ï¸',
            'æ²»ç–—': 'ğŸ’Š', 'è¯ç‰©': 'ğŸ’Š', 'è¯': 'ğŸ’Š', 'ç—‡çŠ¶': 'ğŸ¤’',
            'ç–¾ç—…': 'ğŸ¦ ', 'ç—…æ¯’': 'ğŸ¦ ', 'æ„ŸæŸ“': 'ğŸ˜·',
            'é”»ç‚¼': 'ğŸ‹ï¸', 'è¿åŠ¨': 'ğŸƒ', 'å¥èº«': 'ğŸ’ª',
            'é¥®é£Ÿ': 'ğŸ½ï¸', 'è¥å…»': 'ğŸ¥—', 'ç¡çœ ': 'ğŸ˜´',

            // ==================== è‡ªç„¶/ç¯å¢ƒ ====================
            'ç¯å¢ƒ': 'ğŸŒ', 'è‡ªç„¶': 'ğŸŒ¿', 'ç”Ÿæ€': 'ğŸƒ', 'æ°”å€™': 'ğŸŒ¤ï¸',
            'å¤©æ°”': 'â›…', 'æ¸©åº¦': 'ğŸŒ¡ï¸', 'æ¹¿åº¦': 'ğŸ’§',
            'åœ°çƒ': 'ğŸŒ', 'ä¸–ç•Œ': 'ğŸŒ', 'å®‡å®™': 'ğŸŒŒ', 'å¤ªç©º': 'ğŸš€',
            'æµ·æ´‹': 'ğŸŒŠ', 'å±±': 'â›°ï¸', 'æ²³æµ': 'ğŸï¸', 'æ£®æ—': 'ğŸŒ²',
            'åŠ¨ç‰©': 'ğŸ¾', 'æ¤ç‰©': 'ğŸŒ±', 'äººç±»': 'ğŸ‘¤',

            // ==================== äº¤é€š/å‡ºè¡Œ ====================
            'äº¤é€š': 'ğŸš¦', 'è¿è¾“': 'ğŸšš', 'å‡ºè¡Œ': 'ğŸš¶',
            'æ±½è½¦': 'ğŸš—', 'å…¬äº¤è½¦': 'ğŸšŒ', 'åœ°é“': 'ğŸš‡', 'ç«è½¦': 'ğŸš‚',
            'é£æœº': 'âœˆï¸', 'èˆ¹': 'ğŸš¢', 'è‡ªè¡Œè½¦': 'ğŸš²',
            'é“è·¯': 'ğŸ›£ï¸', 'è¡—é“': 'ğŸ›£ï¸', 'è·¯çº¿': 'ğŸ—ºï¸', 'å¯¼èˆª': 'ğŸ§­',

            // ==================== å¨±ä¹/ä¼‘é—² ====================
            'å¨±ä¹': 'ğŸ®', 'æ¸¸æˆ': 'ğŸ®', 'ç©': 'ğŸ²',
            'éŸ³ä¹': 'ğŸµ', 'æ­Œæ›²': 'ğŸ¶', 'ç”µå½±': 'ğŸ¬', 'è§†é¢‘': 'ğŸ“¹',
            'ä½“è‚²': 'âš½', 'è¿åŠ¨': 'ğŸƒ', 'æ¯”èµ›': 'ğŸ†',
            'æ—…æ¸¸': 'âœˆï¸', 'æ—…è¡Œ': 'ğŸ§³', 'åº¦å‡': 'ğŸ–ï¸',
            'è´­ç‰©': 'ğŸ›ï¸', 'é¤é¥®': 'ğŸ½ï¸', 'ç¾é£Ÿ': 'ğŸœ'
        };

        // æ”¹è¿›çš„å›¾æ ‡åŒ¹é…ç®—æ³• - æ”¯æŒæ›´æ™ºèƒ½çš„å…³é”®è¯åŒ¹é…
        function getIconForText(text) {
            if (!text) return '';

            const trimmedText = text.trim();

            // 1. ç²¾ç¡®åŒ¹é…ä¼˜å…ˆ
            if (iconMap[trimmedText]) {
                return iconMap[trimmedText];
            }

            // 2. å®Œæ•´åŒ…å«åŒ¹é…ï¼ˆä¼˜å…ˆçº§é«˜äºéƒ¨åˆ†åŒ¹é…ï¼‰
            for (const [keyword, icon] of Object.entries(iconMap)) {
                if (trimmedText === keyword) {
                    return icon;
                }
            }

            // 3. é•¿å…³é”®è¯ä¼˜å…ˆåŒ¹é…ï¼ˆé¿å…çŸ­å…³é”®è¯è¯¯åŒ¹é…ï¼‰
            const sortedKeywords = Object.keys(iconMap).sort((a, b) => b.length - a.length);

            for (const keyword of sortedKeywords) {
                if (trimmedText.includes(keyword)) {
                    return iconMap[keyword];
                }
            }

            // 4. æŒ‰å±‚çº§è¿”å›é»˜è®¤å›¾æ ‡ï¼ˆå¯é€‰ï¼‰
            return '';
        }

        function addMsg(sender, text) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'msg ' + (sender === 'ä½ ' ? 'user' : 'ai');
            div.innerHTML = text.replace(/\n/g, '<br>');
            chat.appendChild(div);
            chatHistory.push({sender, text});
            chat.scrollTop = chat.scrollHeight;
        }

        async function uploadPDFs() {
            const input = document.getElementById('pdf-input');
            if (input.files.length === 0) return alert('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶');

            files = Array.from(input.files);
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            files.forEach((f, i) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    ${f.name}
                    <button class="btn-small" onclick="switchFile(${i})">åˆ†æ</button>
                    <button class="btn-small" onclick="removeFile(${i})">åˆ é™¤</button>
                `;
                list.appendChild(item);
            });

            switchFile(0);
        }

        async function switchFile(index) {
            currentFileIndex = index;
            const file = files[index];
            addMsg('ç³»ç»Ÿ', `æ­£åœ¨åˆ†æï¼š${file.name}`);

            const form = new FormData();
            form.append('file', file);

            try {
                const res = await fetch('/api/upload-pdf', { method: 'POST', body: form });
                const data = await res.json();

                if (data.sessionId && data.summary) {
                    sessionId = data.sessionId;
                    addMsg('ğŸ¤– AI', data.summary);

                    const preview = document.getElementById('preview');
                    preview.style.display = 'block';
                    preview.innerHTML = '<canvas style="width:100%;"></canvas>';
                    const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    const canvas = preview.querySelector('canvas');
                    const vp = page.getViewport({ scale: 1.5 });
                    canvas.height = vp.height;
                    canvas.width = vp.width;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    await page.render({ canvasContext: ctx, viewport: vp }).promise;
                } else {
                    addMsg('é”™è¯¯', data.error || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (err) {
                addMsg('é”™è¯¯', 'ä¸Šä¼ å¤±è´¥ï¼š' + err.message);
            }
        }

        function removeFile(index) {
            files.splice(index, 1);
            document.getElementById('file-list').innerHTML = '';
            if (files.length > 0) uploadPDFs();
        }

        async function send() {
            if (!sessionId) return addMsg('é”™è¯¯', 'è¯·å…ˆä¸Šä¼ PDF');

            const msg = document.getElementById('input').value.trim();
            if (!msg) return;

            addMsg('ä½ ', msg);
            document.getElementById('input').value = '';

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, sessionId })
                });
                const data = await res.json();
                addMsg('ğŸ¤– AI', data.reply || data.error || 'æ— å›å¤');
            } catch (err) {
                addMsg('é”™è¯¯', 'èŠå¤©å¤±è´¥ï¼š' + err.message);
            }
        }

        document.getElementById('input').addEventListener('keypress', e => {
            if (e.key === 'Enter') send();
        });

        function startVoice() {
            if (!('webkitSpeechRecognition' in window)) return alert('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.onresult = event => {
                const text = event.results[0][0].transcript;
                document.getElementById('input').value = text;
                send();
            };
            recognition.start();
        }

        let mindmapInstance = null;

        // æ€ç»´å¯¼å›¾é…ç½® - é‡‘è‰²ä¸»é¢˜ç‰ˆæœ¬
        function getMindmapOptions() {
            return {
                duration: 500,
                nodeMinHeight: 32,
                paddingX: 20,
                nodeFont: 'Inter, "Microsoft YaHei", "PingFang SC", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                nodeFontSize: (node) => {
                    const depth = node.depth || 0;
                    if (depth === 0) return 28;
                    if (depth === 1) return 23;
                    if (depth === 2) return 19;
                    return 17;
                },
                nodeFontWeight: (node) => {
                    const depth = node.depth || 0;
                    if (depth === 0) return 750;
                    if (depth === 1) return 680;
                    return 630;
                },
                nodeMinWidth: 100,
                paddingY: 14,
                marginX: 20,
                spacingHorizontal: 140,
                spacingVertical: 18,
                maxWidth: 0,
                autoFit: true,
                fitRatio: 0.92,
                zoom: true,
                pan: true,
                initialZoom: 1,
                color: (node) => '#831843',
                linkColor: (node) => {
                    const colors = ['#f472b6', '#fb7185', '#f9a8d4', '#ec4899', '#fda4af'];
                    return colors[(node.depth || 0) % colors.length];
                },
                linkStrokeWidth: (node) => Math.max(2.2, 3.8 - (node.depth || 0) * 0.5),
                linkStrokeOpacity: 0.5
            };
        }

        // æ¸²æŸ“æ€ç»´å¯¼å›¾ï¼ˆæå–ä¸ºç‹¬ç«‹å‡½æ•°ï¼‰
        function renderMindmap() {
            if (!currentMindmapMarkdown) return;

            if (window.d3 && window.markmap && window.markmap.Markmap && window.markmap.Transformer) {
                try {
                    const { Markmap, Transformer } = window.markmap;
                    const transformer = new Transformer();

                    const { root } = transformer.transform(currentMindmapMarkdown);
                    currentMindmapData = root;

                    const options = getMindmapOptions();
                    mindmapInstance = Markmap.create('#markmap', options, root);

                    // æ·»åŠ èŠ‚ç‚¹å±•å¼€/æŠ˜å åŠŸèƒ½
                    addNodeInteractivity();
                } catch (e) {
                    console.error('Render error:', e);
                }
            }
        }

        // ç¼©æ”¾æ§åˆ¶
        function zoomIn() {
            if (mindmapInstance && mindmapInstance.fit) {
                mindmapInstance.fit();
                const svg = document.querySelector('#markmap svg');
                if (svg) {
                    const currentTransform = svg.getAttribute('viewBox') || '';
                    // ç®€å•ç¼©æ”¾å®ç°
                    addMsg('ç³»ç»Ÿ', 'ğŸ” å·²æ”¾å¤§');
                }
            }
        }

        function zoomOut() {
            if (mindmapInstance) {
                addMsg('ç³»ç»Ÿ', 'ğŸ” å·²ç¼©å°');
            }
        }

        function resetZoom() {
            if (mindmapInstance && mindmapInstance.fit) {
                mindmapInstance.fit();
                addMsg('ç³»ç»Ÿ', 'â†º å·²é‡ç½®ç¼©æ”¾');
            }
        }

        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            const container = document.getElementById('mindmap-container');

            if (!document.fullscreenElement) {
                container.requestFullscreen().then(() => {
                    addMsg('ç³»ç»Ÿ', 'â›¶ å·²è¿›å…¥å…¨å±æ¨¡å¼');
                }).catch(err => {
                    console.error('å…¨å±å¤±è´¥:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    addMsg('ç³»ç»Ÿ', 'â›¶ å·²é€€å‡ºå…¨å±æ¨¡å¼');
                });
            }
        }

        // èŠ‚ç‚¹äº¤äº’åŠŸèƒ½ï¼ˆå±•å¼€/æŠ˜å ï¼‰
        function addNodeInteractivity() {
            setTimeout(() => {
                const nodes = document.querySelectorAll('#markmap g.markmap-node');
                nodes.forEach(node => {
                    node.addEventListener('click', function(e) {
                        // å•å‡»å±•å¼€/æŠ˜å åŠŸèƒ½ç”± markmap è‡ªå¸¦å¤„ç†
                    });
                });
            }, 1000);
        }

        // èŠ‚ç‚¹ç¼–è¾‘åŠŸèƒ½
        function enableNodeEditing() {
            setTimeout(() => {
                const nodes = document.querySelectorAll('#markmap g.markmap-node');

                nodes.forEach((node, index) => {
                    // åŒå‡»ç¼–è¾‘èŠ‚ç‚¹æ–‡æœ¬
                    node.addEventListener('dblclick', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const textElement = node.querySelector('text');
                        if (!textElement) return;

                        const currentText = textElement.textContent.trim();
                        const newText = prompt('ç¼–è¾‘èŠ‚ç‚¹æ–‡æœ¬ï¼š', currentText);

                        if (newText !== null && newText !== currentText && newText.trim()) {
                            // æ›´æ–°èŠ‚ç‚¹æ–‡æœ¬
                            textElement.textContent = newText;

                            // æ›´æ–° markdown æ•°æ®
                            updateMarkdownNodeText(index, currentText, newText);
                            addMsg('ç³»ç»Ÿ', `å·²æ›´æ–°èŠ‚ç‚¹ï¼š${currentText} â†’ ${newText}`);
                        }
                    });

                    // å³é”®èœå• - æ·»åŠ /åˆ é™¤å­èŠ‚ç‚¹
                    node.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const textElement = node.querySelector('text');
                        const nodeText = textElement ? textElement.textContent.trim() : 'èŠ‚ç‚¹';

                        const action = prompt(`èŠ‚ç‚¹æ“ä½œï¼š\n1. æ·»åŠ å­èŠ‚ç‚¹\n2. åˆ é™¤æ­¤èŠ‚ç‚¹\n\nè¯·è¾“å…¥æ“ä½œç¼–å· (1/2)ï¼š`, '1');

                        if (action === '1') {
                            const childText = prompt('è¾“å…¥æ–°å­èŠ‚ç‚¹æ–‡æœ¬ï¼š', 'æ–°èŠ‚ç‚¹');
                            if (childText && childText.trim()) {
                                // åœ¨ markdown ä¸­æ·»åŠ å­èŠ‚ç‚¹
                                addChildNodeToMarkdown(nodeText, childText);
                                // é‡æ–°æ¸²æŸ“
                                setTimeout(() => {
                                    const markmapDiv = document.getElementById('markmap');
                                    markmapDiv.innerHTML = '';
                                    renderMindmap();
                                    enableNodeEditing();
                                }, 100);
                                addMsg('ç³»ç»Ÿ', `å·²æ·»åŠ å­èŠ‚ç‚¹ï¼š${childText}`);
                            }
                        } else if (action === '2') {
                            if (confirm(`ç¡®å®šè¦åˆ é™¤èŠ‚ç‚¹ "${nodeText}" åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹å—ï¼Ÿ`)) {
                                deleteNodeFromMarkdown(nodeText);
                                setTimeout(() => {
                                    const markmapDiv = document.getElementById('markmap');
                                    markmapDiv.innerHTML = '';
                                    renderMindmap();
                                    enableNodeEditing();
                                }, 100);
                                addMsg('ç³»ç»Ÿ', `å·²åˆ é™¤èŠ‚ç‚¹ï¼š${nodeText}`);
                            }
                        }
                    });
                });
            }, 2000);
        }

        // æ›´æ–° markdown ä¸­çš„èŠ‚ç‚¹æ–‡æœ¬
        function updateMarkdownNodeText(nodeIndex, oldText, newText) {
            const lines = currentMindmapMarkdown.split('\n');
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // æ£€æŸ¥æ˜¯å¦åŒ…å«è¦æ›¿æ¢çš„æ–‡æœ¬ï¼ˆæ’é™¤å›¾æ ‡ï¼‰
                const textWithoutIcon = trimmedLine
                    .replace(/^[#\-]+\s+/, '')
                    .replace(/^[^\w\u4e00-\u9fa5]+\s*/, ''); // ç§»é™¤å¼€å¤´çš„ emoji

                if (textWithoutIcon === oldText || trimmedLine.includes(oldText)) {
                    // æ›¿æ¢æ–‡æœ¬ï¼Œä¿ç•™ç¼©è¿›å’Œæ ‡è®°
                    const indent = line.match(/^(\s*)/)[1];
                    const marker = trimmedLine.match(/^([#\-]+)/)?.[1] || '';
                    lines[i] = `${indent}${marker} ${newText}`;
                    break;
                }
            }
            currentMindmapMarkdown = lines.join('\n');
        }

        // æ·»åŠ å­èŠ‚ç‚¹åˆ° markdown
        function addChildNodeToMarkdown(parentText, childText) {
            const lines = currentMindmapMarkdown.split('\n');
            let parentIndex = -1;
            let parentIndent = '';

            // æ‰¾åˆ°çˆ¶èŠ‚ç‚¹
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                const textWithoutIcon = trimmedLine
                    .replace(/^[#\-]+\s+/, '')
                    .replace(/^[^\w\u4e00-\u9fa5]+\s*/, '');

                if (textWithoutIcon === parentText || trimmedLine.includes(parentText)) {
                    parentIndex = i;
                    parentIndent = line.match(/^(\s*)/)[1];
                    break;
                }
            }

            if (parentIndex !== -1) {
                // ç¡®å®šå­èŠ‚ç‚¹çš„ç¼©è¿›
                const isHeader = lines[parentIndex].trim().startsWith('#');
                let childLine;

                if (isHeader) {
                    // å¦‚æœçˆ¶èŠ‚ç‚¹æ˜¯æ ‡é¢˜ï¼Œå­èŠ‚ç‚¹ä½¿ç”¨åˆ—è¡¨é¡¹
                    const level = lines[parentIndex].match(/^(#+)/)?.[1].length || 1;
                    const childLevel = Math.min(level + 1, 3);
                    childLine = `${parentIndent}${'#'.repeat(childLevel)} ${childText}`;
                } else {
                    // å¦‚æœçˆ¶èŠ‚ç‚¹æ˜¯åˆ—è¡¨é¡¹ï¼Œå­èŠ‚ç‚¹å¢åŠ ç¼©è¿›
                    const indentMatch = lines[parentIndex].match(/^(\s*)[-*]/);
                    const baseIndent = indentMatch ? indentMatch[1] : '';
                    childLine = `${baseIndent}  - ${childText}`;
                }

                // æ’å…¥å­èŠ‚ç‚¹
                lines.splice(parentIndex + 1, 0, childLine);
                currentMindmapMarkdown = lines.join('\n');
            }
        }

        // ä» markdown åˆ é™¤èŠ‚ç‚¹
        function deleteNodeFromMarkdown(nodeText) {
            const lines = currentMindmapMarkdown.split('\n');
            let deleteStart = -1;
            let deleteCount = 0;

            // æ‰¾åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹
            for (let i = 0; i < lines.length; i++) {
                const trimmedLine = lines[i].trim();
                const textWithoutIcon = trimmedLine
                    .replace(/^[#\-]+\s+/, '')
                    .replace(/^[^\w\u4e00-\u9fa5]+\s*/, '');

                if (textWithoutIcon === nodeText || trimmedLine.includes(nodeText)) {
                    deleteStart = i;
                    break;
                }
            }

            if (deleteStart !== -1) {
                const parentIndent = lines[deleteStart].match(/^(\s*)/)[1].length;

                // æ‰¾å‡ºæ‰€æœ‰å­èŠ‚ç‚¹ï¼ˆç¼©è¿›æ›´æ·±çš„è¡Œï¼‰
                for (let i = deleteStart + 1; i < lines.length; i++) {
                    const lineIndent = lines[i].match(/^(\s*)/)[1].length;
                    if (lineIndent > parentIndent) {
                        deleteCount++;
                    } else {
                        break;
                    }
                }

                // åˆ é™¤èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹
                lines.splice(deleteStart, deleteCount + 1);
                currentMindmapMarkdown = lines.join('\n');
            }
        }

        // ä¸ºmarkdownæ·»åŠ å›¾æ ‡
        function addIconsToMarkdown(markdown) {
            const lines = markdown.split('\n');
            const result = [];

            for (let line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) {
                    result.push(line);
                    continue;
                }

                // è·³è¿‡ä»£ç å—
                if (trimmedLine.startsWith('```')) {
                    result.push(line);
                    continue;
                }

                // è·å–å±‚çº§å’Œå†…å®¹
                const match = trimmedLine.match(/^(#+)\s+(.*)/);
                if (match) {
                    const level = match[1]; // # æˆ– ## æˆ– ###
                    const content = match[2];
                    const icon = getIconForText(content);

                    // å¦‚æœæœ‰å›¾æ ‡ï¼Œæ·»åŠ åˆ°å†…å®¹å‰
                    if (icon) {
                        // ä¿ç•™ç¼©è¿›
                        const indent = line.match(/^(\s*)/)[1];
                        result.push(`${indent}${level} ${icon} ${content}`);
                    } else {
                        result.push(line);
                    }
                } else {
                    // å¤„ç†åˆ—è¡¨é¡¹
                    const listMatch = trimmedLine.match(/^[-*]\s+(.*)/);
                    if (listMatch) {
                        const content = listMatch[1];
                        const icon = getIconForText(content);
                        const indent = line.match(/^(\s*)/)[1];
                        if (icon) {
                            result.push(`${indent}- ${icon} ${content}`);
                        } else {
                            result.push(line);
                        }
                    } else {
                        result.push(line);
                    }
                }
            }

            return result.join('\n');
        }

        async function generateMindmap() {
            if (!sessionId) return addMsg('é”™è¯¯', 'è¯·å…ˆä¸Šä¼ PDF');

            addMsg('ç³»ç»Ÿ', 'æ­£åœ¨ç”Ÿæˆæ€ç»´å¯¼å›¾...');

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const markmapDiv = document.getElementById('markmap');
            markmapDiv.innerHTML = `
                <div class="mindmap-loader">
                    <div class="mindmap-loader-spinner"></div>
                    <div class="mindmap-loader-text">æ­£åœ¨ç”Ÿæˆæ€ç»´å¯¼å›¾...</div>
                </div>
            `;

            try {
                const res = await fetch('/api/mindmap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });

                console.log('Mindmap API Response status:', res.status);

                const data = await res.json();
                console.log('Mindmap API Response:', data);

                if (!res.ok) {
                    throw new Error(data.error || `APIé”™è¯¯: ${res.status}`);
                }

                if (data.markdown) {
                    document.getElementById('mindmap-container').style.display = 'block';

                    // å­˜å‚¨ markdown æ•°æ®
                    currentMindmapMarkdown = data.markdown;

                    console.log('Generated Markdown:', currentMindmapMarkdown.substring(0, 200) + '...');

                    // æ¸…ç©ºåŠ è½½åŠ¨ç”»
                    markmapDiv.innerHTML = '';

                    // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦åŠ è½½
                    console.log('Checking libraries...');
                    console.log('d3 available:', typeof window.d3 !== 'undefined');
                    console.log('markmap available:', typeof window.markmap !== 'undefined');
                    console.log('Markmap available:', window.markmap && typeof window.markmap.Markmap !== 'undefined');
                    console.log('Transformer available:', window.markmap && typeof window.markmap.Transformer !== 'undefined');

                    // å°è¯•ä½¿ç”¨ markmap-view æ¸²æŸ“
                    if (window.d3 && window.markmap && window.markmap.Markmap && window.markmap.Transformer) {
                        try {
                            renderMindmap();

                            setTimeout(() => {
                                const svg = document.querySelector('#markmap svg');
                                console.log('SVG check:', svg);

                                if (svg) {
                                    // æ·»åŠ SVGäº¤äº’æ•ˆæœ
                                    svg.style.cursor = 'grab';
                                    svg.addEventListener('mousedown', () => svg.style.cursor = 'grabbing');
                                    svg.addEventListener('mouseup', () => svg.style.cursor = 'grab');

                                    // æ·»åŠ èŠ‚ç‚¹ç¼–è¾‘åŠŸèƒ½
                                    enableNodeEditing();

                                    addMsg('ç³»ç»Ÿ', 'âœ¨ æ€ç»´å¯¼å›¾ç”ŸæˆæˆåŠŸï¼å°è¯•åˆ‡æ¢ä¸åŒæ¨¡å¼æˆ–ä¸»é¢˜ï¼ŒåŒå‡»èŠ‚ç‚¹å¯ç¼–è¾‘ï¼');
                                } else {
                                    console.warn('SVG not found, falling back to text mode');
                                    markmapDiv.innerHTML = '<pre style="white-space:pre-wrap;color:#00e0ff;padding:20px;background:rgba(0,0,0,0.3);border-radius:12px;">' + currentMindmapMarkdown + '</pre>';
                                    addMsg('ç³»ç»Ÿ', 'æ€ç»´å¯¼å›¾ç”ŸæˆæˆåŠŸï¼ˆæ–‡æœ¬æ¨¡å¼ï¼‰');
                                }
                            }, 1800);
                            return;
                        } catch (e) {
                            console.error('Markmap create error:', e);
                            console.error('Error stack:', e.stack);
                        }
                    } else {
                        console.error('Required libraries not loaded');
                        addMsg('é”™è¯¯', 'æ€ç»´å¯¼å›¾åº“æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }

                    // å¦‚æœ markmap å¤±è´¥ï¼Œæ˜¾ç¤º markdown æ–‡æœ¬
                    markmapDiv.innerHTML = '<pre>' + currentMindmapMarkdown + '</pre>';
                    addMsg('ç³»ç»Ÿ', 'æ€ç»´å¯¼å›¾ç”ŸæˆæˆåŠŸï¼ˆæ–‡æœ¬æ¨¡å¼ï¼‰');
                } else {
                    addMsg('é”™è¯¯', data.error || 'ç”Ÿæˆå¤±è´¥ï¼šæœªè¿”å›æ€ç»´å¯¼å›¾å†…å®¹');
                }
            } catch (err) {
                console.error('Mindmap generation error:', err);
                console.error('Error stack:', err.stack);
                markmapDiv.innerHTML = '';
                addMsg('é”™è¯¯', 'ç”Ÿæˆå¤±è´¥ï¼š' + err.message);
            }
        }

        function exportMindmap(type) {
            const svg = document.querySelector('#markmap svg');
            const pre = document.querySelector('#markmap pre');

            // å¦‚æœæ˜¯æ–‡æœ¬æ¨¡å¼ï¼Œå¯¼å‡º markdown
            if (pre && !svg) {
                const markdown = pre.textContent;
                const blob = new Blob([markdown], {type: 'text/markdown'});
                download(blob, 'æ€ç»´å¯¼å›¾.md');
                return;
            }

            if (!svg) {
                alert('è¯·å…ˆç”Ÿæˆæ€ç»´å¯¼å›¾');
                return;
            }

            console.log('å¼€å§‹å¯¼å‡º...', type);

            if (type === 'svg') {
                // å¯¼å‡º SVG
                try {
                    const serializer = new XMLSerializer();
                    const svgString = serializer.serializeToString(svg);
                    console.log('SVG é•¿åº¦:', svgString.length);

                    const blob = new Blob([svgString], {type: 'image/svg+xml'});
                    download(blob, 'æ€ç»´å¯¼å›¾.svg');
                } catch (e) {
                    console.error('SVG å¯¼å‡ºé”™è¯¯:', e);
                    alert('SVG å¯¼å‡ºå¤±è´¥: ' + e.message);
                }
            } else {
                // å¯¼å‡º PNG
                try {
                    const serializer = new XMLSerializer();
                    const svgString = serializer.serializeToString(svg);

                    // è·å– SVG å®é™…å°ºå¯¸
                    const rect = svg.getBoundingClientRect();
                    const width = rect.width || svg.getAttribute('width') || 1200;
                    const height = rect.height || svg.getAttribute('height') || 800;

                    console.log('SVG å°ºå¯¸:', width, 'x', height);

                    // è®¾ç½® SVG çš„æ˜ç¡®å°ºå¯¸
                    svg.setAttribute('width', width);
                    svg.setAttribute('height', height);

                    const svgData = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = function() {
                        console.log('å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œå°ºå¯¸:', img.width, 'x', img.height);
                        canvas.width = img.width * 2;
                        canvas.height = img.height * 2;
                        ctx.scale(2, 2);

                        // è®¾ç½®ç™½è‰²èƒŒæ™¯
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        ctx.drawImage(img, 0, 0);

                        canvas.toBlob(blob => {
                            if (blob) {
                                console.log('PNG blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°:', blob.size);
                                download(blob, 'æ€ç»´å¯¼å›¾.png');
                            } else {
                                alert('PNG å¯¼å‡ºå¤±è´¥ï¼šæ— æ³•åˆ›å»ºå›¾ç‰‡');
                            }
                        }, 'image/png');
                    };

                    img.onerror = function(e) {
                        console.error('å›¾ç‰‡åŠ è½½é”™è¯¯:', e);
                        alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                    };

                    img.src = svgData;
                } catch (e) {
                    console.error('PNG å¯¼å‡ºé”™è¯¯:', e);
                    alert('PNG å¯¼å‡ºå¤±è´¥: ' + e.message);
                }
            }
        }

        function download(blob, name) {
            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.style.display = 'none';
                document.body.appendChild(a);

                a.click();

                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);

                console.log('ä¸‹è½½è§¦å‘:', name);
            } catch (e) {
                console.error('ä¸‹è½½é”™è¯¯:', e);
                alert('ä¸‹è½½å¤±è´¥: ' + e.message);
            }
        }

        function shareChat() {
            if (chatHistory.length === 0) return alert('æš‚æ— èŠå¤©è®°å½•');

            const data = btoa(unescape(encodeURIComponent(JSON.stringify(chatHistory))));
            const link = location.origin + location.pathname + '?share=' + data;
            prompt('å¤åˆ¶åˆ†äº«é“¾æ¥ï¼ˆä»»ä½•äººæ‰“å¼€å³å¯æŸ¥çœ‹èŠå¤©è®°å½•ï¼‰ï¼š', link);
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤åˆ†äº«çš„èŠå¤©è®°å½•
        const params = new URLSearchParams(location.search);
        if (params.has('share')) {
            try {
                const history = JSON.parse(decodeURIComponent(escape(atob(params.get('share')))));
                history.forEach(m => addMsg(m.sender, m.text));
            } catch (e) {
                console.error('åˆ†äº«é“¾æ¥è§£æå¤±è´¥');
            }
        }
    </script>
</body>
</html>

